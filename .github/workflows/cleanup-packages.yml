name: Cleanup Packages

on:
  workflow_dispatch:

permissions:
  packages: write

jobs:
  delete-old-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Delete packages older than 24 hours
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          YESTERDAY=$(date -d '24 hours ago' -u +'%Y-%m-%dT%H:%M:%SZ')

          echo "Fetching packages for repository $REPO_FULL_NAME..."
          PACKAGES=$(gh api "/user/packages" --paginate -q '.[] | select(.repository.full_name == "'"$REPO_FULL_NAME"'") | {name, type: .package_type}')

          if [ -z "$PACKAGES" ]; then
            echo "No packages found for repository."
            exit 0
          fi

          echo "$PACKAGES" | jq -c '.' | while read -r package; do
            PACKAGE_NAME=$(echo "$package" | jq -r '.name')
            PACKAGE_TYPE=$(echo "$package" | jq -r '.type')

            echo "PACKAGE_NAME: $PACKAGE_NAME"
            echo "PACKAGE_TYPE: $PACKAGE_TYPE"

            if [ -z "$PACKAGE_NAME" ] || [ -z "$PACKAGE_TYPE" ]; then
              echo "Skipping package due to missing name or type."
              continue
            fi

            echo "--- Processing package: $PACKAGE_NAME (Type: $PACKAGE_TYPE) ---"

            VERSIONS_JSON=$(gh api "/user/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions" --paginate)

            if [ -z "$VERSIONS_JSON" ]; then
              echo "No versions found for $PACKAGE_NAME."
              continue
            fi

            if [ "$PACKAGE_TYPE" == "container" ]; then
              # For container packages, we add extra safety checks:
              # 1. Skip versions that are untagged (`length > 0`), as these can be intermediate layers or in-progress builds.
              # 2. Always preserve the 'latest' tag to avoid breaking production deployments.
              QUERY='map(select(.created_at < "'$YESTERDAY'" and (.metadata.container.tags | length > 0) and (.metadata.container.tags | contains(["latest"]) | not))) | .[] | .id'
            else
              QUERY='map(select(.created_at < "'$YESTERDAY'")) | .[] | .id'
            fi

            OLD_VERSION_IDS=$(echo "$VERSIONS_JSON" | jq -r "$QUERY")

            if [ -z "$OLD_VERSION_IDS" ]; then
              echo "No old versions to delete for $PACKAGE_NAME."
              continue
            fi

            echo "The following version IDs will be deleted for $PACKAGE_NAME:"
            echo "$OLD_VERSION_IDS"

            echo "$OLD_VERSION_IDS" | while read -r ID; do
              echo "Deleting version ID: $ID"
              gh api --method DELETE "/user/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions/$ID" --silent || echo "Failed to delete version ID $ID, it may have already been deleted."
            done

            echo "--- Finished processing package: $PACKAGE_NAME ---"
          done
